<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wer würde eher...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: flex;
        }
        #timer-circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.1s linear;
        }
        .pie-chart-container {
            width: 90%;
            max-width: 400px;
            height: auto;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-lg mx-auto p-4 md:p-6 bg-white rounded-2xl shadow-xl">

        <!-- Screen 1: Name & Lobby Code Input -->
        <div id="name-screen" class="screen active flex-col items-center gap-6">
            <h1 class="text-3xl font-bold text-gray-900">Wer würde eher...</h1>
            <div class="w-full flex flex-col gap-4">
                 <input type="text" id="name-input" placeholder="Dein Name" class="w-full p-3 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                 <input type="text" id="lobby-code-input" placeholder="Lobby-Code (optional)" class="w-full p-3 border border-gray-300 rounded-lg text-center uppercase focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                 <div class="grid grid-cols-2 gap-3">
                    <button id="create-lobby-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Lobby erstellen</button>
                    <button id="join-lobby-button" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Lobby beitreten</button>
                 </div>
                 <button id="test-game-button" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Testrunde starten</button>
            </div>
            <p id="error-message" class="text-red-500 text-sm mt-2"></p>
        </div>

        <!-- Screen 2: Lobby -->
        <div id="lobby-screen" class="screen flex-col items-center gap-4">
            <div class="text-center">
                 <h2 class="text-2xl font-bold">Lobby</h2>
                 <div class="mt-2">
                    <span class="text-gray-500">Lobby-Code:</span>
                    <span id="lobby-code-display" class="font-bold text-2xl text-indigo-600 tracking-widest bg-gray-100 p-2 rounded-lg"></span>
                 </div>
            </div>
            <p class="text-gray-500">Warte auf weitere Spieler...</p>
            <div id="player-list" class="w-full bg-gray-50 p-4 rounded-lg min-h-[100px] space-y-2">
                <!-- Player names will be injected here -->
            </div>
            <div id="host-controls" class="hidden w-full flex flex-col gap-3 mt-4">
                 <div class="w-full">
                    <label for="category-select" class="block text-sm font-medium text-gray-700 mb-1">Kategorie</label>
                    <select id="category-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <!-- Categories will be injected here -->
                    </select>
                </div>
                <button id="start-game-button" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">Spiel starten</button>
                <button id="reset-lobby-button" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-transform transform hover:scale-105">Lobby auflösen</button>
            </div>
             <p id="lobby-info-for-players" class="text-center text-gray-600 mt-4"></p>
             <button id="leave-lobby-button" class="mt-4 text-sm text-gray-500 hover:text-red-600">Lobby verlassen</button>
        </div>

        <!-- Screen 3: Game -->
        <div id="game-screen" class="screen flex-col items-center gap-4">
            <div class="relative w-24 h-24">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <!-- Background circle -->
                    <circle class="stroke-gray-200" stroke-width="10" fill="transparent" r="45" cx="50" cy="50" />
                    <!-- Progress circle -->
                    <circle id="timer-circle" class="stroke-indigo-600" stroke-width="10" stroke-linecap="round" fill="transparent" r="45" cx="50" cy="50"></circle>
                </svg>
                <span id="timer-text" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-bold">20</span>
            </div>
            <p id="question-counter" class="text-sm font-semibold text-gray-500"></p>
            <h3 class="text-xl md:text-2xl font-semibold text-center mt-2" id="question-text"></h3>
            <div id="vote-options" class="w-full grid grid-cols-2 gap-3 mt-4">
                <!-- Vote buttons will be injected here -->
            </div>
            <p id="vote-info" class="text-center text-gray-500 mt-2 hidden">Du hast bereits abgestimmt.</p>
            <img id="waiting-gif" src="https://media.tenor.com/nZQlCgAcIXQAAAAi/hood-irony-ghetto-smosh.gif" alt="Warten..." class="hidden w-48 h-48 mx-auto mt-4 rounded-lg">
        </div>

        <!-- Screen 4: Results -->
        <div id="results-screen" class="screen flex-col items-center gap-4">
            <p id="results-question-counter" class="text-sm font-semibold text-gray-500"></p>
            <h3 class="text-xl font-semibold text-center" id="results-question-text"></h3>
            <p class="text-gray-600 text-center mt-2">Ergebnisse der Abstimmung:</p>
            <div class="pie-chart-container">
                <canvas id="results-chart"></canvas>
            </div>
            <div id="results-host-controls" class="hidden w-full flex flex-col gap-3 mt-4">
                <button id="next-question-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">Nächste Frage</button>
                <button id="end-game-button" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600">Spiel beenden</button>
            </div>
             <p id="results-info-for-players" class="text-center text-gray-600 mt-4">Warte auf den Host für die nächste Runde...</p>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyANV7_AKN8oZIpJ1JjIVuokO2Q6Gc-iN04",
            authDomain: "wer-wuerde-eher-70d61.firebaseapp.com",
            projectId: "wer-wuerde-eher-70d61",
            storageBucket: "wer-wuerde-eher-70d61.firebasestorage.app",
            messagingSenderId: "301727904397",
            appId: "1:301727904397:web:eec5b088e46425946b68c4",
        };

        const QUESTIONS = {
            'Standard': [
                "Wer würde eher einen Bungeesprung machen?", "Wer würde eher im Lotto gewinnen und alles für Unsinn ausgeben?", "Wer würde eher eine Reality-TV-Show gewinnen?", "Wer würde eher 2 Wochen ohne Handy auskommen?", "Wer würde eher einen Fremden auf der Straße umarmen?", "Wer würde eher ein Buch schreiben?", "Wer würde eher auf einen Berg klettern?", "Wer würde eher eine Weltreise alleine machen?", "Wer würde eher ein Haustier aus einem Tierheim adoptieren?", "Wer würde eher den ganzen Tag im Bett verbringen?", "Wer würde eher einen Witz erzählen, über den niemand lacht?", "Wer würde eher ein komplettes Menü für alle kochen?", "Wer würde eher in einem Horrorfilm als erstes sterben?", "Wer würde eher eine neue Sprache in einem Monat lernen?", "Wer würde eher bei einer Talentshow mitmachen?", "Wer würde eher seinen Job kündigen, um Influencer zu werden?", "Wer würde eher barfuß durch die Stadt laufen?", "Wer würde eher ein Geheimnis für sich behalten?", "Wer würde eher einen Streit anfangen?", "Wer würde eher zu spät zu seiner eigenen Hochzeit kommen?"
            ],
            'Peinlich': [
                "Wer würde eher in der Öffentlichkeit stolpern und hinfallen?", "Wer würde eher den Namen seines Dates vergessen?", "Wer würde eher mit Toilettenpapier am Schuh herumlaufen?", "Wer würde eher in einer Bibliothek laut lachen?", "Wer würde eher die falsche Person küssen?", "Wer würde eher eine peinliche Nachricht an die falsche Person schicken?", "Wer würde eher beim Essen etwas auf sein weißes Hemd kleckern?", "Wer würde eher im Kino laut schnarchen?", "Wer würde eher gegen eine Glastür laufen?", "Wer würde eher versuchen, eine automatische Tür aufzuschieben?", "Wer würde eher seinen Hosenstall offen lassen?", "Wer würde eher in einem wichtigen Meeting einen Lachanfall bekommen?", "Wer würde eher auf einer Party der Letzte sein, der geht?", "Wer würde eher ein schreckliches Geschenk machen?", "Wer würde eher im Supermarkt etwas fallen lassen und so tun, als wäre nichts passiert?", "Wer würde eher laut im Auto singen und an der Ampel erwischt werden?", "Wer würde eher mit dem Lehrer mit Vornamen reden?", "Wer würde eher im Restaurant das Essen zurückgehen lassen?", "Wer würde eher über seine eigenen Füße fallen?", "Wer würde eher die Pointe eines Witzes verderben?"
            ],
            'Party': [
                "Wer würde eher auf den Tischen tanzen?", "Wer würde eher als erstes einschlafen?", "Wer würde eher den DJ bestechen, ein schlechtes Lied zu spielen?", "Wer würde eher mit einer Pflanze reden?", "Wer würde eher eine Polonaise starten?", "Wer würde eher alle Getränke mixen und probieren?", "Wer würde eher am nächsten Morgen nichts mehr wissen?", "Wer würde eher Karaoke singen, obwohl er es nicht kann?", "Wer würde eher versuchen, mit dem Barkeeper zu flirten?", "Wer würde eher die Snacks alleine aufessen?", "Wer würde eher einen peinlichen Tanzmove auspacken?", "Wer würde eher mit dem Gastgeber über Politik diskutieren?", "Wer würde eher die Musik übernehmen und alle nerven?", "Wer würde eher heimlich gehen, ohne sich zu verabschieden?", "Wer würde eher ein Trinkspiel vorschlagen?", "Wer würde eher am nächsten Tag beim Aufräumen helfen?", "Wer würde eher eine Wette verlieren und etwas Dummes tun müssen?", "Wer würde eher Fotos von schlafenden Leuten machen?", "Wer würde eher eine Rede halten, obwohl niemand zuhört?", "Wer würde eher versuchen, einen Zaubertrick vorzuführen und scheitern?"
            ]
        };

        // --- APPLICATION STATE ---
        let app, auth, db, isFirebaseReady = false;
        let currentUser = null;
        let localPlayerName = '';
        let currentLobbyId = null;
        let gameUnsubscribe = null;
        let currentChart = null;
        let timerInterval = null;

        // --- UI ELEMENTS ---
        const screens = { name: document.getElementById('name-screen'), lobby: document.getElementById('lobby-screen'), game: document.getElementById('game-screen'), results: document.getElementById('results-screen') };
        const nameInput = document.getElementById('name-input');
        const lobbyCodeInput = document.getElementById('lobby-code-input');
        const createLobbyButton = document.getElementById('create-lobby-button');
        const joinLobbyButton = document.getElementById('join-lobby-button');
        const testGameButton = document.getElementById('test-game-button');
        const nameScreenButtons = [createLobbyButton, joinLobbyButton, testGameButton];
        const errorMessage = document.getElementById('error-message');
        const playerList = document.getElementById('player-list');
        const hostControls = document.getElementById('host-controls');
        const startGameButton = document.getElementById('start-game-button');
        const resetLobbyButton = document.getElementById('reset-lobby-button');
        const questionText = document.getElementById('question-text');
        const questionCounter = document.getElementById('question-counter');
        const voteOptions = document.getElementById('vote-options');
        const voteInfo = document.getElementById('vote-info');
        const waitingGif = document.getElementById('waiting-gif');
        const resultsQuestionText = document.getElementById('results-question-text');
        const resultsQuestionCounter = document.getElementById('results-question-counter');
        const resultsChartCanvas = document.getElementById('results-chart');
        const resultsHostControls = document.getElementById('results-host-controls');
        const nextQuestionButton = document.getElementById('next-question-button');
        const endGameButton = document.getElementById('end-game-button');
        const categorySelect = document.getElementById('category-select');
        const lobbyInfoForPlayers = document.getElementById('lobby-info-for-players');
        const resultsInfoForPlayers = document.getElementById('results-info-for-players');
        const timerCircle = document.getElementById('timer-circle');
        const timerText = document.getElementById('timer-text');
        const lobbyCodeDisplay = document.getElementById('lobby-code-display');
        const leaveLobbyButton = document.getElementById('leave-lobby-button');

        // --- FUNCTIONS ---

        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) screens[screenName].classList.add('active');
        }

        function populateCategories() {
            categorySelect.innerHTML = '';
            Object.keys(QUESTIONS).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }
        
        function generateLobbyCode() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        function validateInputs() {
            const name = nameInput.value.trim();
            if (name.length < 2 || name.length > 15) {
                errorMessage.textContent = 'Name muss zwischen 2 und 15 Zeichen lang sein.';
                return false;
            }
            localPlayerName = name;
            errorMessage.textContent = '';
            return true;
        }

        async function initializeGame() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, user => {
                    currentUser = user;
                    if (user) {
                        isFirebaseReady = true;
                        nameScreenButtons.forEach(btn => btn.disabled = false);
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                            errorMessage.textContent = "Verbindung zum Server fehlgeschlagen.";
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                errorMessage.textContent = "Verbindung zum Server konnte nicht hergestellt werden.";
            }
        }

        createLobbyButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !validateInputs()) return;
            
            const newLobbyId = generateLobbyCode();
            currentLobbyId = newLobbyId;
            const gameDocRef = doc(db, "lobbies", newLobbyId);

            const newLobbyState = {
                hostId: currentUser.uid,
                status: 'lobby',
                players: { [currentUser.uid]: { name: localPlayerName } },
                currentCategory: 'Standard',
                currentQuestionIndex: 0,
                votes: {},
                createdAt: serverTimestamp()
            };
            
            try {
                await setDoc(gameDocRef, newLobbyState);
                if (gameUnsubscribe) gameUnsubscribe();
                gameUnsubscribe = onSnapshot(gameDocRef, handleGameStateUpdate);
            } catch (error) {
                console.error("Error creating lobby:", error);
                errorMessage.textContent = "Fehler beim Erstellen der Lobby.";
            }
        });

        joinLobbyButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !validateInputs()) return;
            const lobbyId = lobbyCodeInput.value.trim().toUpperCase();
            if (!lobbyId) {
                errorMessage.textContent = "Bitte gib einen Lobby-Code ein.";
                return;
            }

            const gameDocRef = doc(db, "lobbies", lobbyId);
            try {
                const gameDoc = await getDoc(gameDocRef);
                if (!gameDoc.exists()) {
                    errorMessage.textContent = "Lobby nicht gefunden.";
                    return;
                }
                
                const gameState = gameDoc.data();
                if (gameState.status !== 'lobby') {
                    errorMessage.textContent = "Diese Lobby ist nicht offen für neue Spieler.";
                    return;
                }

                currentLobbyId = lobbyId;
                const playerPath = `players.${currentUser.uid}`;
                await updateDoc(gameDocRef, { [playerPath]: { name: localPlayerName } });

                if (gameUnsubscribe) gameUnsubscribe();
                gameUnsubscribe = onSnapshot(gameDocRef, handleGameStateUpdate);

            } catch (error) {
                console.error("Error joining lobby:", error);
                errorMessage.textContent = "Fehler beim Beitreten zur Lobby.";
            }
        });
        
        testGameButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !validateInputs()) return;

            const newLobbyId = `TEST-${generateLobbyCode()}`;
            currentLobbyId = newLobbyId;
            const gameDocRef = doc(db, "lobbies", newLobbyId);

            const testLobbyState = {
                hostId: currentUser.uid,
                status: 'lobby',
                players: { [currentUser.uid]: { name: localPlayerName } },
                currentCategory: 'Standard',
                currentQuestionIndex: 0,
                votes: {},
                createdAt: serverTimestamp()
            };

            try {
                await setDoc(gameDocRef, testLobbyState);
                await updateDoc(gameDocRef, {
                    status: 'playing',
                    timerStartedAt: serverTimestamp()
                });

                if (gameUnsubscribe) gameUnsubscribe();
                gameUnsubscribe = onSnapshot(gameDocRef, handleGameStateUpdate);

                setTimeout(async () => {
                    const freshDoc = await getDoc(gameDocRef);
                    if (freshDoc.exists() && freshDoc.data().status === 'playing' && freshDoc.data().currentQuestionIndex === 0) {
                         await updateDoc(gameDocRef, { status: 'results' });
                    }
                }, 20500);

            } catch (error) {
                console.error("Error starting test game:", error);
                errorMessage.textContent = "Fehler beim Starten des Testspiels.";
            }
        });

        leaveLobbyButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !currentLobbyId) return;
            
            const gameDocRef = doc(db, "lobbies", currentLobbyId);
            
            try {
                const gameDoc = await getDoc(gameDocRef);
                if(gameDoc.exists() && gameDoc.data().hostId === currentUser.uid) {
                    await dissolveLobby();
                } else {
                    const playerPath = `players.${currentUser.uid}`;
                    await updateDoc(gameDocRef, { [playerPath]: deleteField() });
                    resetLocalState();
                }
            } catch(error) {
                console.error("Error leaving lobby:", error);
                resetLocalState();
            }
        });


        function handleGameStateUpdate(docSnapshot) {
            if (!docSnapshot.exists()) {
                alert("Die Lobby wurde vom Host aufgelöst.");
                resetLocalState();
                return;
            }

            const gameState = docSnapshot.data();
            const isHost = gameState.hostId === currentUser.uid;
            const playerIds = Object.keys(gameState.players);
            const isPlayerInGame = playerIds.includes(currentUser.uid);

            if (!isPlayerInGame && localPlayerName) {
                resetLocalState();
                alert("Du bist nicht mehr in der Lobby.");
                return;
            }

            currentLobbyId = docSnapshot.id;
            lobbyCodeDisplay.textContent = currentLobbyId;

            if (gameState.status === 'lobby') {
                switchScreen('lobby');
                renderPlayerList(gameState.players, gameState.hostId);
                hostControls.classList.toggle('hidden', !isHost);
                startGameButton.disabled = playerIds.length < 2;
                categorySelect.value = gameState.currentCategory;
                lobbyInfoForPlayers.textContent = isHost ? (playerIds.length < 2 ? 'Warte auf mindestens einen weiteren Spieler...' : '') : `Der Host (${gameState.players[gameState.hostId]?.name}) startet das Spiel.`;
            } else if (gameState.status === 'playing') {
                switchScreen('game');
                const categoryQuestions = QUESTIONS[gameState.currentCategory] || [];
                const totalQuestions = categoryQuestions.length;
                const currentIndex = gameState.currentQuestionIndex;
                const question = categoryQuestions[currentIndex] || "Keine Frage mehr in dieser Kategorie.";
                
                questionCounter.textContent = `Frage ${currentIndex + 1} / ${totalQuestions}`;
                questionText.textContent = question;
                renderVoteOptions(gameState.players, gameState.votes);
                updateTimer(gameState.timerStartedAt);
                
                const hasVoted = gameState.votes && gameState.votes[currentUser.uid];
                waitingGif.classList.toggle('hidden', !hasVoted);

            } else if (gameState.status === 'results') {
                if (timerInterval) clearInterval(timerInterval);
                switchScreen('results');
                waitingGif.classList.add('hidden');
                const categoryQuestions = QUESTIONS[gameState.currentCategory] || [];
                const totalQuestions = categoryQuestions.length;
                const currentIndex = gameState.currentQuestionIndex;
                const question = categoryQuestions[currentIndex] || "Letzte Frage wurde ausgewertet.";

                resultsQuestionCounter.textContent = `Frage ${currentIndex + 1} / ${totalQuestions}`;
                resultsQuestionText.textContent = question;
                renderResultsChart(gameState.players, gameState.votes);
                resultsHostControls.classList.toggle('hidden', !isHost);
                resultsInfoForPlayers.textContent = isHost ? '' : `Warte auf den Host für die nächste Runde...`;
            } else if (gameState.status === 'game_over') {
                 if (isHost) {
                    dissolveLobby();
                }
            }
        }

        function renderPlayerList(players, hostId) {
            playerList.innerHTML = Object.entries(players).map(([id, p]) => 
                `<div class="p-2 bg-white rounded shadow-sm flex justify-between items-center">
                    <span>${p.name}</span>
                    ${id === hostId ? '<span class="text-xs font-bold text-indigo-500">HOST</span>' : ''}
                </div>`
            ).join('');
        }

        function renderVoteOptions(players, votes) {
            voteOptions.innerHTML = '';
            const hasVoted = votes && votes[currentUser.uid];
            voteInfo.style.display = hasVoted ? 'block' : 'none';

            if (Object.keys(players).length === 1) {
                 const playerId = Object.keys(players)[0];
                 const button = document.createElement('button');
                 button.textContent = players[playerId].name;
                 button.dataset.voteFor = playerId;
                 button.disabled = hasVoted;
                 button.className = `p-3 rounded-lg font-semibold transition-transform transform col-span-2 ${
                    hasVoted ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-indigo-100 text-indigo-800 hover:bg-indigo-200 hover:scale-105'
                }`;
                 button.addEventListener('click', handleVote);
                 voteOptions.appendChild(button);
            } else {
                for (const playerId in players) {
                    const button = document.createElement('button');
                    button.textContent = players[playerId].name;
                    button.dataset.voteFor = playerId;
                    button.disabled = hasVoted;
                    button.className = `p-3 rounded-lg font-semibold transition-transform transform ${
                        hasVoted ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-indigo-100 text-indigo-800 hover:bg-indigo-200 hover:scale-105'
                    }`;
                    button.addEventListener('click', handleVote);
                    voteOptions.appendChild(button);
                }
            }
        }

        function renderResultsChart(players, votes) {
            const voteCounts = {};
            Object.values(players).forEach(p => voteCounts[p.name] = 0);

            Object.values(votes).forEach(votedForId => {
                if (players[votedForId]) {
                    voteCounts[players[votedForId].name]++;
                }
            });

            const labels = Object.keys(voteCounts);
            const data = Object.values(voteCounts);

            if (currentChart) currentChart.destroy();
            
            const textColor = '#1F2937';
            const borderColor = '#ffffff';

            currentChart = new Chart(resultsChartCanvas, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stimmen',
                        data: data,
                        backgroundColor: ['#818cf8', '#a78bfa', '#f472b6', '#fb923c', '#facc15', '#4ade80', '#2dd4bf', '#60a5fa'],
                        borderColor: borderColor,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: textColor } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label || ''}: ${ctx.parsed || 0} Stimme(n)` } }
                    }
                }
            });
        }
        
        function setCircleProgress(percent) {
            const radius = timerCircle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            timerCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - percent * circumference;
            timerCircle.style.strokeDashoffset = offset;
        }

        function updateTimer(timerStartedAt) {
            if (timerInterval) clearInterval(timerInterval);
            if (!timerStartedAt) {
                timerText.textContent = '20';
                setCircleProgress(1); // Full circle
                return;
            }

            const startTime = timerStartedAt.toDate().getTime();
            const totalDuration = 20000;

            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remainingSeconds = Math.max(0, Math.ceil((totalDuration - elapsed) / 1000));
                timerText.textContent = remainingSeconds;
                const progress = Math.max(0, (totalDuration - elapsed) / totalDuration);
                setCircleProgress(progress);
                if (elapsed >= totalDuration) {
                    clearInterval(timerInterval);
                    waitingGif.classList.add('hidden');
                }
            }, 100);
        }

        async function handleVote(event) {
            if (!isFirebaseReady) return;
            const votedForId = event.target.dataset.voteFor;
            const gameDocRef = doc(db, "lobbies", currentLobbyId);
            const votePath = `votes.${currentUser.uid}`;
            await updateDoc(gameDocRef, { [votePath]: votedForId });
        }
        
        async function dissolveLobby() {
            if (!isFirebaseReady || !currentLobbyId) return;
            await deleteDoc(doc(db, "lobbies", currentLobbyId));
        }
        
        function resetLocalState() {
            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = null;
            if (timerInterval) clearInterval(timerInterval);
            
            localPlayerName = '';
            currentLobbyId = null;
            nameInput.value = '';
            lobbyCodeInput.value = '';
            errorMessage.textContent = '';
            waitingGif.classList.add('hidden');
            switchScreen('name');
        }

        // --- HOST ACTIONS ---
        resetLobbyButton.addEventListener('click', dissolveLobby);

        startGameButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !currentLobbyId) return;
            const gameDocRef = doc(db, "lobbies", currentLobbyId);
            const gameDoc = await getDoc(gameDocRef);
            const gameState = gameDoc.data();
            
            const categoryQuestions = QUESTIONS[gameState.currentCategory] || [];
            if (categoryQuestions.length === 0) {
                alert("Diese Kategorie hat keine Fragen. Bitte wähle eine andere.");
                return;
            }

            await updateDoc(gameDocRef, {
                status: 'playing',
                currentQuestionIndex: 0,
                votes: {},
                timerStartedAt: serverTimestamp()
            });
            
            setTimeout(async () => {
                const freshDoc = await getDoc(gameDocRef);
                if (freshDoc.exists() && freshDoc.data().status === 'playing' && freshDoc.data().currentQuestionIndex === 0) {
                     await updateDoc(gameDocRef, { status: 'results' });
                }
            }, 20500);
        });
        
        categorySelect.addEventListener('change', async (e) => {
            if (!isFirebaseReady || !currentLobbyId) return;
            const newCategory = e.target.value;
            const gameDocRef = doc(db, "lobbies", currentLobbyId);
            await updateDoc(gameDocRef, { currentCategory: newCategory });
        });
        
        nextQuestionButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !currentLobbyId) return;
            const gameDocRef = doc(db, "lobbies", currentLobbyId);
            const gameDoc = await getDoc(gameDocRef);
            const gameState = gameDoc.data();
            
            const categoryQuestions = QUESTIONS[gameState.currentCategory] || [];
            const nextIndex = gameState.currentQuestionIndex + 1;

            if (nextIndex >= categoryQuestions.length) {
                await updateDoc(gameDocRef, { status: 'game_over' });
            } else {
                await updateDoc(gameDocRef, {
                    status: 'playing',
                    currentQuestionIndex: nextIndex,
                    votes: {},
                    timerStartedAt: serverTimestamp()
                });
                
                setTimeout(async () => {
                    const freshDoc = await getDoc(gameDocRef);
                    if (freshDoc.exists() && freshDoc.data().status === 'playing' && freshDoc.data().currentQuestionIndex === nextIndex) {
                         await updateDoc(gameDocRef, { status: 'results' });
                    }
                }, 20500);
            }
        });

        endGameButton.addEventListener('click', async () => {
            if (!isFirebaseReady || !currentLobbyId) return;
            const gameDocRef = doc(db, "lobbies", currentLobbyId);
            await updateDoc(gameDocRef, { status: 'game_over' });
        });

        // --- INITIALIZATION ---
        populateCategories();
        initializeGame();

    </script>
</body>
</html>
